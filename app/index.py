import hashlib
import math

from flask import render_template, request, redirect, url_for, flash
import dao
from app import app, login
from flask_login import login_user, logout_user, current_user, login_required
import cloudinary.uploader

from app.models import Class, UserRoleEnum, ScoreType, User, Semester


@app.route("/")
def index():
    kw = request.args.get("kw")
    class_id = request.args.get('class_id')
    grade_id = request.args.get('grade_id')
    page = request.args.get('page')

    grads = dao.get_grades()
    clas = dao.get_classes_by_grade(grade_id)
    studs = dao.get_students(kw, class_id, page)
    num = dao.count_student()
    page_size = app.config['PAGE_SIZE']

    return render_template("index.html", classes=clas,
                           students=studs, grades=grads, pages=math.ceil(num / page_size))


@app.route("/about")
def about_page():
    return render_template("about.html")


@app.context_processor
def utility_functions():
    def get_classes_by_grade(grade_id):
        return Class.query.filter(Class.grade_id == grade_id).all()

    return {
        'grades': dao.get_grades(),
        'get_classes_by_grade': get_classes_by_grade
    }


@app.route("/classes/<int:class_id>")
def class_detail(class_id):
    kw = request.args.get("kw")
    cla = dao.get_class_by_id(class_id)
    studs = dao.get_students_by_class(class_id)
    return render_template("class_detail.html", students=studs, class_info=cla)


@app.route('/manage_scores', methods=['GET', 'POST'])
def manage_scores():
    if current_user.is_authenticated and current_user.user_role == UserRoleEnum.TEACHER:
        if request.method == 'POST':
            # Lấy học kỳ từ form
            semester_id = request.form.get('semester_id')

            # Chuyển hướng đến trang hiển thị các lớp và môn học
            return redirect(url_for('teacher_dashboard', semester_id=semester_id))
        semesters = dao.get_semester()
    else:
        return redirect(url_for('user_login'))

    return render_template('manage_scores.html', semesters=semesters)


@app.route('/teacher_dashboard/<semester_id>')
def teacher_dashboard(semester_id):
    # Lấy danh sách các lớp và môn học trong học kỳ này
    classes_subjects = dao.get_classes_and_subjects(current_user.id, semester_id)

    # Hiển thị trang cho học kỳ này
    return render_template('teacher_dashboard.html', classes_subjects=classes_subjects)


@app.route('/input_scores/<class_id>/<subject_id>/<semester_id>', methods=['GET', 'POST'])
def input_scores(class_id, subject_id, semester_id):
    if request.method == 'POST':
        # Lấy thông tin từ form
        student_id = request.form.get('student_id')
        type_id = request.form.get('type_id')
        score_value = request.form.get('score_value')

        message = dao.input_score(student_id=student_id, type_id=type_id, score_value=score_value,
                                  subject_id=subject_id, semester_id=semester_id)
        if message:
            flash(message)
            return redirect(url_for('input_scores', class_id=class_id, subject_id=subject_id, semester_id=semester_id))
        return redirect(url_for('input_scores', semester_id=semester_id, class_id=class_id, subject_id=subject_id))

    # Lấy danh sách sinh viên trong lớp
    students = dao.get_students_by_class(class_id=class_id)
    semests = dao.get_semester()
    score_types = dao.get_score_type()  # Lấy tất cả các ScoreType
    return render_template('input_scores.html', students=students, semesters=semests, score_types=score_types)


@app.route('/view_scores/<class_id>/<subject_id>/<semester_id>', methods=['GET'])
def view_scores(class_id, subject_id, semester_id):
    students_scores = dao.get_students_scores(class_id, subject_id, semester_id=semester_id)
    return render_template('view_scores.html', scores=students_scores)


@app.route('/student_scores', methods=['GET'])
def student_scores():
    if current_user.is_authenticated and current_user.user_role == UserRoleEnum.STUDENT:
        scores = dao.get_scores(current_user.id)
        scores_by_semester = dao.get_scores_by_semester(scores)
        semester_averages = dao.calculate_semester_averages(scores_by_semester)
    else:
        return redirect(url_for('user_login'))
    return render_template('student_scores.html', scores_by_semester=scores_by_semester,
                           semester_averages=semester_averages)


@app.route("/teachers")
def load_teachers():
    teachs = dao.get_teachers()
    return render_template("teachers.html", teachers=teachs)


@app.route("/user_register", methods=['get', 'post'])
def user_register():
    err_msg = ""
    if request.method.__eq__('POST'):
        username = request.form.get('username')
        password = request.form.get('password')
        confirm = request.form.get('confirm')
        avatar_path = None
        try:
            if password.strip().__eq__(confirm.strip()):
                avatar = request.files.get('avatar')
                if avatar:
                    res = cloudinary.uploader.upload(avatar)
                    avatar_path = res['secure_url']
                    print("Avatar path:", avatar_path)
                else:
                    print("Error")
                dao.add_user(username=username, password=password, avatar=avatar_path)
                return redirect(url_for('index'))
            else:
                err_msg = 'Mật khẩu xác nhận không khớp!!'
        except Exception as ex:
            err_msg = 'Lỗi ' + str(ex)

    return render_template('register.html', err_msg=err_msg)


@app.route('/user_login', methods=['get', 'post'])
def user_login():
    err_msg = ''
    if request.method.__eq__('POST'):
        username = request.form.get('username')
        password = request.form.get('password')

        user = dao.auth_user(username=username, password=password)
        if user:
            login_user(user=user)
            return redirect(url_for('index'))
        else:
            err_msg = 'Username hoặc password không hợp lệ!!'
    return render_template('login.html', err_msg=err_msg)


@app.route("/user_logout")
def user_logout():
    logout_user()
    return redirect(url_for('user_login'))


@app.route("/admin/login", methods=['post'])
def admin_login():
    username = request.form.get('username')
    password = request.form.get('password')

    user = dao.auth_user(username=username, password=password)
    if user:
        login_user(user)

    return redirect("/admin")


@login.user_loader
def load_user(user_id):
    return dao.get_user_by_id(user_id)


@app.route("/change_password", methods=['GET', 'POST'])
def change_password():
    if request.method == 'POST':
        old_password = request.form.get('old_password')
        new_password = request.form.get('new_password')
        confirm_password = request.form.get('confirm_password')

        # Assuming 'current_user' is the logged in user
        hashed_old_password = str(hashlib.md5(old_password.strip().encode('utf-8')).hexdigest())

        if not hashed_old_password == current_user.password:
            flash('Mật khẩu cũ không chính xác')
            return redirect(url_for('change_password'))

        if new_password != confirm_password:
            flash('Mật khẩu mới không khớp')
            return redirect(url_for('change_password'))

        dao.change_password(current_user, new_password)
        flash('Mật khẩu đã được thay đổi thành công')
        return redirect(url_for('index'))

    return render_template('change_password.html')


if __name__ == "__main__":
    from app import admin

    app.run(debug=True)
